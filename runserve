#!/bin/bash
version='0.0.14'

PURPLE='\033[0;35m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color


fnHelp () {
    echo ' '
    echo "runserve help            - show help!!!"
    echo "         bash            - go to runserve container and run bash shell"
    echo "         config          - initialize runserve global config"
    echo "         init            - initialize runserve individual config in present folder"
    echo "         force           - force kill runserve container and restart to bash shell"
    echo "         version         - version of this file"
    echo "         update          - updating this file"
    echo ' '
    exit 1
}

fnVersion () {
  latest=$(curl -s https://raw.githubusercontent.com/runserve/runserve/master/runserve.latest)
    echo "v"$version
}

fnVersionCheck () {
  latest=$(curl -s https://raw.githubusercontent.com/runserve/runserve/master/runserve.latest)
  if [[ "$version" != "$latest" ]]; then
    echo ' '
    echo -e "${YELLOW}         NEW VERSION IS AVAILABLE !!! "
    echo ' '
    echo '          *************************'
    echo '          *                       *'
    echo '          *   runserve v.'$latest'   *'
    echo '          *                       *'
    echo '          *************************'
    echo ' '
    echo -e "run: ${NC}runserve upgrade${YELLOW} - to update to newest version"
    echo -e "${NC}"
  elif [[ $1 = update ]]; then
    echo " "
    echo -e "Latest runserve version: $latest - everything is updated!"
    echo " "
  fi
}

fnForce () {
    fnGetConfig
    echo 'Killing runserve container...'
    docker stop $containerName -t 0
    echo 'Restarting container...'
    sleep 3
    fnBash
    exit 1
}

fnBash () {
    fnVersionCheck
    fnGetConfig
    docker run --rm --name='runserve-dev-env' -it -v $(pwd):/app -e GITUSER="$gitUser" -e GITEMAIL="$gitEmail" -e PORT=4200 -p 4200:4200 -p 3000:3000 -p 8080:8080 $dockerImage containerStart $2 $3 $4 $5 $6 $7 $8 $9
    #read -p "Commit changes before terminate runserver? [Y/n]: " changes
    exit 1
}

fnGetConfig () {
    if [ -f "./.runserve/config" ]; then
      source ./.runserve/config
    else 
      source ~/.runserve/config
    # else
    #     fnInitGlobalConfig
    fi

}

fnInitChooseEnvironment () {
    echo > ./.runserve/config
    echo "Choose environment:"
        echo "1) Angular"
        echo "2) NodeJS"
        echo "3) Typescript"
        read -p "Choose number [$envNo]: " envNewNo
        if [[ -z $envNewNo ]]; then envNewNo=$envNo; fi
        if [[ $envNewNo = 1 ]]; then fnInitChooseAngularVersion;
        elif [[ $envNewNo = 2 ]]; then fnInitChooseNodeJSVersion;
        elif [[ $envNewNo = 3 ]]; then fnInitChooseTypescriptVersion;
        else envNewNo=$envNo
        fi
        echo "envNo='$envNewNo'" >> ./.runserve/config
        echo "dockerImage='$dockerImage'" >> ./.runserve/config
}

fnInitChooseGlobalEnvironment () {
    echo > ~/.runserve/config
    echo "Choose environment:"
        echo "1) Angular"
        echo "2) NodeJS"
        echo "3) Typescript"
        read -p "Choose number [$envNo]: " envNewNo
        if [[ -z $envNewNo ]]; then envNewNo=$envNo; fi
        if [[ $envNewNo = 1 ]]; then fnInitChooseAngularVersion;
        elif [[ $envNewNo = 2 ]]; then fnInitChooseNodeJSVersion;
        elif [[ $envNewNo = 3 ]]; then fnInitChooseTypescriptVersion;
        else envNewNo=$envNo
        fi
        echo "envNo='$envNewNo'" >> ~/.runserve/config
        echo "dockerImage='$dockerImage'" >> ~/.runserve/config
}

fnInitChooseAngularVersion () {
        read -p "Available versions: [7.3.1], [7.3.2], [7.3.3], [7.3.4], [7.3.5], [7.3.6], [latest]: " dockerImage
            if [[ $dockerImage = 7.3.1  || $dockerImage = 7.3.2 || $dockerImage = 7.3.3 || $dockerImage = 7.3.4 || $dockerImage = 7.3.5 || $dockerImage = 7.3.6 ]]; then dockerImage="runserve/angular:$dockerImage"
            else dockerImage="runserve/angular:latest"
            fi
}

fnInitChooseNodeVersion () {
        echo "NODEJS SERVER IS NOT AVAILABLE IN THIS VERSION" 
}

fnInitChooseTypescriptVersion () {
        read -p "Available versions: [3.2.4], [latest]: " dockerImage
            if [[ $dockerImage = 3.2.4] ]]; then dockerImage="runserve/typescript:$dockerImage"
            else dockerImage="runserve/typescript:latest"
            fi
}

fnInitGitConfig () {
    read -p "Configure GIT? [Y/n]: " gitConfig
    if [[ $gitConfig = n ]]; then
        echo "GIT skipped"
    else
        read -p "Git login [$gitUser]: " gitNewUser
        if [[ $gitNewUser ]]; then gitUser=$gitNewUser; fi
        echo "gitUser='$gitUser'" >> ./.runserve/config
        read -p "Git email [$gitEmail]: " gitNewEmail
        if [[ $gitNewEmail ]]; then gitEmail=$gitNewEmail; fi
        echo "gitEmail='$gitEmail'" >> ./.runserve/config
        read -p "Git address [$gitAddress]: " gitNewAddress
        if [[ $gitNewAddress ]]; then gitAddress=$gitNewAddress; fi
        echo "gitAddress='$gitAddress'" >> ./.runserve/config
    fi
}

fnInitGlobalGitConfig () {
        read -p "Git login [$gitUser]: " gitNewUser
        if [[ $gitNewUser ]]; then gitUser=$gitNewUser; fi
        echo "gitUser='$gitUser'" >> ~/.runserve/config
        read -p "Git email [$gitEmail]: " gitNewEmail
        if [[ $gitNewEmail ]]; then gitEmail=$gitNewEmail; fi
        echo "gitEmail='$gitEmail'" >> ~/.runserve/config
}

fnInitGlobalConfig (){
    mkdir ~/.runserve
    touch ~/.runserve/config
    fnInitChooseGlobalEnvironment
    fnInitGlobalGitConfig
    
}

fnInitConfig () {
    ### CHECK CONFIG VARS:
    fnGetConfig
    mkdir ./.runserve
    touch ./.runserve/config
    fnInitChooseEnvironment
    fnInitGitConfig
    




    if [[ $1 = bash ]]; then fnBash
    else
      exit 1;
    fi
}







#################################################################
### OS DETECT:
# if [[ "$OSTYPE" == "linux-gnu" ]]; then
#         RAND=$(shuf -i 100-199 -n 1)
# elif [[ "$OSTYPE" == "darwin"* ]]; then
#         RAND=$(jot -r 1 100 199)
# fi
#################################################################
### READ CONFIG VARS:


################################################################

#################################################################
## CTRL-V CTRL-Z KEYPRESS:
stty quit "^Z"
trap " docker stop $containerName" 3;
trap ctrl_c INT
function ctrl_c(){
    echo " docker stopping, wait few seconds..."
    docker stop $containerName
    echo 'docker stopped'
}
#################################################################


if [[ $1 = version ]]; then fnVersion
elif [[ $1 = config ]]; then fnInitGlobalConfig
elif [[ $1 = init ]]; then fnInitConfig
elif [[ $1 = -h || $1 = --help || $1 = help ]]; then fnHelp
elif [[ $1 = bash ]]; then fnBash
elif [[ $1 = force ]]; then fnForce
elif [[ $1 = update ]]; then
    if [[ $2 = dev ]]; then
        if [[ $3 = getfrombin ]]; then
            cp ~/bin/runserve ./runserve
        elif [[ $3 = puttobin ]]; then
            cp ./runserve ~/bin/runserve
        else
            echo 'getfrombin || puttobin'
        fi
    else
        fnVersionCheck "$1"
    fi
    exit 1
elif [[ $1 = upgrade ]]; then
    if [[ "$OSTYPE" == "linux-gnu" ]]; then
    curl https://raw.githubusercontent.com/runserve/runserve/master/runserve > /usr/local/bin/runserve
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        brew upgrade runserve
    fi
else fnHelp

fi
